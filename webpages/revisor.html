<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revisor - Panel principal</title>
    <link rel="stylesheet" href="../styles/styles_general.css">
    <link rel="stylesheet" href="../styles/styles_revisor.css">
</head>
<body>
    <header class="site-header">
        <div class="header-top">
            <div class="container">
                <div class="logo-text">PT</div>
                <h1 class="title">PULSO<span class="gold">TEC</span></h1>
            </div>
        </div>
        <nav class="nav-bar">
            <div class="container">
                <ul class="nav-list">
                    <li><a href="../Index.html">INICIO</a></li>
                    <li><a href="#">DOCUMENTOS</a></li>
                    <!-- <li><a href="#">AYUDA</a></li> -->
                    <li class="login"><a href="./login.html">CERRAR SESIÓN</a></li>
                </ul>
            </div>
        </nav>
    </header>



    
    <main class="container revisor-main">
        <section class="revisor-overview">
            <div class="overview-copy">
                <h2>Panel de revisión</h2>
                <p class="muted">Gestiona tus solicitudes y prioriza las revisiones que ya aceptaste. Mantén tu bandeja limpia antes de tomar nuevos documentos.</p>
            </div>
            <div class="overview-metrics">
                <article class="metric-card is-critical" aria-label="Revisiones en curso">
                    <span class="metric-label">Pendientes</span>
                    <span class="metric-value" data-metric="pending-count">0</span>
                    <p class="metric-sub" data-metric="pending-next">Sin entregas próximas</p>
                </article>
                <article class="metric-card is-info" aria-label="Nuevos documentos asignados">
                    <span class="metric-label">Nuevos</span>
                    <span class="metric-value" data-metric="new-count">0</span>
                    <p class="metric-sub" data-metric="new-info">Coordinación no ha asignado nuevos documentos</p>
                </article>
                <article class="metric-card is-success" aria-label="Revisiones entregadas">
                    <span class="metric-label">Entregadas</span>
                    <span class="metric-value" data-metric="completed-count">0</span>
                    <p class="metric-sub" data-metric="completed-info">Aún sin revisiones entregadas</p>
                </article>
            </div>
        </section>

        <section class="revisor-board">
            <!-- <article class="card new-card" aria-labelledby="new-title">
                <header class="card-head">
                    <div>
                        <h3 id="new-title">Nuevos asignados</h3> -->
                        <!-- esto de bandeja para que es? -->
                        <!-- <p class="muted">El área de coordinación te asignó estos documentos. Confirma la recepción para moverlos a tu bandeja.</p>
                    </div>
                    <span class="badge badge-info">Nuevos</span>
                </header>

                <ul class="doc-queue" data-sync="new" data-variant="card" data-empty="empty-new"></ul>
                <div class="doc-empty" id="empty-new" hidden>No tienes nuevos documentos pendientes de confirmar.</div>
            </article> -->

            <article class="card focus-card" aria-labelledby="focus-title">
                <header class="card-head">
                    <div>
                        <h3 id="focus-title">Revisiones pendientes</h3>
                        <p class="muted">Accede a tus documentos en curso y continúa con la evaluación cuando lo necesites.</p>
                    </div>
                    <span class="badge badge-critical">Prioridad alta</span>
                </header>

                <ul class="doc-queue focus-list" data-sync="pending" data-variant="card" data-limit="3" data-empty="empty-pending"></ul>
                <div class="doc-empty" id="empty-pending" hidden>Cuando confirmes o avances un documento aparecerá aquí.</div>
            </article>

            <aside class="card board-card" aria-labelledby="board-title">
                <header class="card-head">
                    <div>
                        <h3 id="board-title">Bandeja de documentos</h3>
                        <p class="muted">Consulta los documentos recién asignados, tus revisiones en curso y el historial.</p>
                    </div>
                    <!-- <button class="btn-secondary" type="button">Exportar resumen</button> -->
                </header>


                <!-- BUSCADOR DE DOCUMENTOS -->
                <div class="board-tools">
                    <label class="sr-only" for="search">Buscar documentos</label>
                    <input id="search" type="search" placeholder="Buscar por título, autor o fecha...">
                </div>


                <!-- TABS PARA LAS LISTAS DE DOCUMENTOS -->
                <div class="tabs board-tabs" role="tablist" aria-label="Listas de documentos">
                    <button id="tab-nuevos" class="tab is-active" role="tab" aria-selected="true" data-target="panel-nuevos">Nuevos</button>
                    <button id="tab-pendientes" class="tab" role="tab" aria-selected="false" data-target="panel-pendientes">En curso</button>
                    <button id="tab-revisados" class="tab" role="tab" aria-selected="false" data-target="panel-revisados">Revisados</button>
                </div>

                <!-- PÁNELES DE AVISOS DE "NO DOCUMENTOS ENCONTRADOS" -->
                <div class="panels">
                    <ul id="panel-nuevos" class="docs-list panel is-active" role="tabpanel" aria-labelledby="tab-nuevos" data-sync="new" data-variant="table" data-empty="empty-panel-new"></ul>
                    <div class="doc-empty is-panel" id="empty-panel-new" hidden>Sin nuevos documentos asignados por el momento.</div>

                    <ul id="panel-pendientes" class="docs-list panel" role="tabpanel" aria-labelledby="tab-pendientes" data-sync="pending" data-variant="table" data-empty="empty-panel-pending"></ul>
                    <div class="doc-empty is-panel" id="empty-panel-pending" hidden>No tienes documentos en curso.</div>

                    <ul id="panel-revisados" class="docs-list panel" role="tabpanel" aria-labelledby="tab-revisados" data-sync="completed" data-variant="table" data-empty="empty-panel-completed"></ul>
                    <div class="doc-empty is-panel" id="empty-panel-completed" hidden>Aún no hay revisiones concluidas.</div>
                </div>


            </aside>
        </section>
    </main>

    <script>
    (function () {
        const $ = (sel, root=document) => root.querySelector(sel);
        const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

        // Tabs para la bandeja
        $$('.board-tabs .tab').forEach(tab => {
            tab.addEventListener('click', () => {
                $$('.board-tabs .tab').forEach(t => t.classList.remove('is-active'));
                tab.classList.add('is-active');
                $$('.panel').forEach(panel => panel.classList.remove('is-active'));
                $('#' + tab.dataset.target).classList.add('is-active');
            });
        });

        

        const locale = 'es-MX';
        const dateOptionsLong = { day: '2-digit', month: 'long', year: 'numeric' };
        const dateOptionsShort = { day: '2-digit', month: 'short', year: 'numeric' };

        state = {
            new: [],
            pending: [],
            completed: []
        };

        pendingProjects = fetch('../php/revisor_getProyectos.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                // Aquí se procesa la información recibida
                console.log('Proyectos recibidos:', data.proyectos);
                data.proyectos.forEach(proy => {
                    //Solo defino los campos que de verdad uso, no todos los que definió G
                    //los meto a pending, new o completed segun corresponda
                    //TODO LO SIGUIENTE ES UNSAFE, TENGO QUE CAMBIARLO PARA QUE USE SESSION DE PHP MEJOR
                    const ruta = `review-session.html?doc=${proy.entregas[proy.entregas.length-1].pdfPath}&title=${proy.nombre}`;
                    switch (proy.entregas[proy.entregas.length-1].aceptado) {
                        case null:
                            state.pending.push({
                                title: proy.nombre,
                                assigned: proy.entregas[0].fechaEntrega,//TODO, esta será puesta manualmente por el manager
                                due: proy.fechaLimite,
                                route: ruta,
                                id: proy.id
                            });
                            break;
                        
                        case 0:
                        case 1:
                            state.completed.push({
                                title: proy.nombre,
                                completed: '2025-10-10',//TODO, mejor le quito esto luego
                                logRoute: ruta,
                                verdict: proy.entregas[proy.entregas.length-1].aceptado ? 'Aceptado' : 'Rechazado',
                                id: proy.id
                            });
                            break;
                    }
                    
                });
                console.log(state);
                renderAll();
            } else {
                console.error('Error al obtener proyectos:', data.message);
            }
        })

        const metrics = {
            pending: $('[data-metric="pending-count"]'),
            pendingInfo: $('[data-metric="pending-next"]'),
            new: $('[data-metric="new-count"]'),
            newInfo: $('[data-metric="new-info"]'),
            completed: $('[data-metric="completed-count"]'),
            completedInfo: $('[data-metric="completed-info"]')
        };

        function parseDate(value) {
            return new Date(value + 'T00:00:00');
        }

        function formatDateLong(value) {
            return parseDate(value).toLocaleDateString(locale, dateOptionsLong);
        }

        function formatDateShort(value) {
            return parseDate(value).toLocaleDateString(locale, dateOptionsShort);
        }

        function getSortKey(type) {
            if (type === 'completed') return 'completed';
            return 'assigned';
        }

        function renderAll() {
            ['new', 'pending', 'completed'].forEach(renderType);
            updateMetrics();
        }

        function renderType(type) {
            const lists = document.querySelectorAll(`[data-sync="${type}"]`);
            if (!lists.length) return;

            const source = state[type]
                .slice()
                .sort((a, b) => parseDate(b[getSortKey(type)]) - parseDate(a[getSortKey(type)]));

            lists.forEach(list => {
                const limit = Number(list.dataset.limit) || source.length;
                const variant = list.dataset.variant || 'table';
                const items = source.slice(0, limit);

                list.innerHTML = '';

                items.forEach(item => {
                    list.appendChild(createListItem(type, item, variant));
                });

                const emptyId = list.dataset.empty;
                if (emptyId) {
                    const emptyElement = document.getElementById(emptyId);
                    if (emptyElement) {
                        emptyElement.hidden = source.length > 0;
                    }
                }
            });
        }

        function createListItem(type, item, variant) {
            if (variant === 'card') {
                const li = document.createElement('li');
                li.className = 'doc-row' + (type === 'new' ? ' is-new' : '');
                li.dataset.id = item.id;
                const summary = item.summary ? `<p class="doc-summary">${item.summary}</p>` : '';
                const dueInfo = item.due ? `<span>Entrega: ${formatDateLong(item.due)}</span>` : '';
                const actions = type === 'new'
                    ? `
                        <button class="btn-primary" data-action="start" data-id="${item.id}" data-route="${item.route}">Comenzar revisión</button>
                        <button class="btn-outline" data-action="ack" data-id="${item.id}">Mover a bandeja</button>
                    `
                    : `
                        <button class="btn-outline" data-action="open" data-id="${item.id}" data-route="${item.route}">Continuar</button>
                    `;
                li.innerHTML = `
                    <div class="doc-info">
                        <h4 class="doc-title">${item.title}</h4>
                        <p class="doc-meta">
                            <span>Asignado: ${formatDateLong(item.assigned)}</span>
                            ${dueInfo ? ' · ' + dueInfo : ''}
                        </p>
                        ${summary}
                    </div>
                    <div class="doc-actions">
                        ${actions}
                    </div>
                `;
                return li;
            }

            const li = document.createElement('li');
            li.className = 'doc-item';
            li.dataset.id = item.id;

            let sub = '';
            let actionMarkup = '';

            if (type === 'new' || type === 'pending') {
                sub = `Asignado: ${formatDateShort(item.assigned)} · Entrega: ${formatDateShort(item.due)}`;
                const label = type === 'new' ? 'Registrar y abrir' : 'Continuar';
                const action = type === 'new' ? 'start' : 'open';
                const buttonClass = type === 'new' ? 'btn-tertiary' : 'btn-tertiary';
                actionMarkup = `<button class="${buttonClass}" data-action="${action}" data-id="${item.id}" data-route="${item.route}">${label}</button>`;
            } else {
                sub = `Revisado: ${formatDateShort(item.completed)} · Dictamen: ${item.verdict}`;
                actionMarkup = `<a class="link" href="${item.logRoute || '#'}" aria-label="Ver bitácora de ${item.title}">Bitácora</a>`;
            }

            li.innerHTML = `
                <div class="thumb" aria-hidden="true"></div>
                <div class="meta">
                    <div class="title-panels">${item.title}</div>
                    <div class="sub">${sub}</div>
                </div>
                ${actionMarkup}
            `;

            return li;
        }

        function updateMetrics() {
            if (metrics.pending) metrics.pending.textContent = state.pending.length;
            if (metrics.new) metrics.new.textContent = state.new.length;
            if (metrics.completed) metrics.completed.textContent = state.completed.length;

            if (metrics.pendingInfo) {
                if (!state.pending.length) {
                    metrics.pendingInfo.textContent = 'Sin entregas próximas';
                } else {
                    const nextDue = state.pending.slice().sort((a, b) => parseDate(a.due) - parseDate(b.due))[0];
                    metrics.pendingInfo.textContent = `Próxima entrega: ${formatDateShort(nextDue.due)}`;
                }
            }

            if (metrics.newInfo) {
                metrics.newInfo.textContent = state.new.length
                    ? `Coordinación asignó ${state.new.length} documento(s) reciente(s)`
                    : 'Coordinación no ha asignado nuevos documentos';
            }

            if (metrics.completedInfo) {
                if (!state.completed.length) {
                    metrics.completedInfo.textContent = 'Aún sin revisiones entregadas';
                } else {
                    const latest = state.completed
                        .slice()
                        .sort((a, b) => parseDate(b.completed) - parseDate(a.completed))[0];
                    metrics.completedInfo.textContent = `Última revisión: ${formatDateShort(latest.completed)}`;
                }
            }
        }

        function moveToPending(id) {
            const index = state.new.findIndex(item => item.id === id);
            if (index === -1) return;
            const [item] = state.new.splice(index, 1);
            state.pending.push(item);
            renderAll();
        }

        document.addEventListener('click', async event => {
            const button = event.target.closest('[data-action]');
            if (!button) return;
            const action = button.dataset.action;
            const id = button.dataset.id;
            if (!id) return;

            if (action === 'ack') {
                moveToPending(id);
                return;
            }

            if (action === 'start') {
                moveToPending(id);
                const route = button.dataset.route;
                if (route) {
                    await fetch('../php/revisor_guardarIds.php', { method: 'POST', credentials: 'same-origin' , body: JSON.stringify({ id }) });
                    window.location.href = route;
                }
                return;
            }

            if (action === 'open') {
                const route = button.dataset.route;
                if (route) {
                    await fetch('../php/revisor_guardarIds.php', { method: 'POST', credentials: 'same-origin' , body: JSON.stringify({ id }) });
                    window.location.href = route;
                }
            }
        });

        renderAll();
    })();
    </script>
</body>
</html>

