<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autor - Panel principal</title>
    <link rel="stylesheet" href="../styles/styles_general.css">
    <link rel="stylesheet" href="../styles/styles_author.css">
</head>





<body>

    <!-- TITULO Y NAV INICIAL -->
    <header class="site-header">
        <div class="header-top">
            <div class="container">
                <div class="logo-text">PT</div>
                <h1 class="title">PULSO<span class="gold">TEC</span></h1>
            </div>
        </div>
        <nav class="nav-bar">
            <div class="container">
                <ul class="nav-list">
                    <li><a href="../Index.html">INICIO</a></li>
                    <li><a href="#">MIS PROYECTOS</a></li>
                    <!-- <li><a href="#">AYUDA</a></li> -->
                    <li class="login"><a href="../webpages/login.html">CERRAR SESIÓN</a></li>
                </ul>
            </div>
        </nav>
    </header>



    <main class="container author-main">

        <!-- MIS PROYECTOS TITULO -->
        <section class="author-intro">
            <h2>Mis proyectos</h2>
            <p class="muted">Organiza tus entregas en proyectos. Cada proyecto resguarda la versión original del documento y la versión revisada después de recibir comentarios.</p>
        </section>


        <section class="author-grid">

            <!-- INICIAR NUEVO PROYECTO -->
            <article class="card new-project-card" aria-labelledby="new-project-title">
                <header class="card-head">
                    <h2 id="new-project-title">Iniciar nuevo proyecto</h2>
                    <p class="muted">Genera un espacio de trabajo y sube la primera versión de tu documento. Podrás adjuntar la revisión cuando recibas retroalimentación.</p>
                </header>

                <form id="new-project-form" class="stack" action="" method="post" enctype="multipart/form-data" novalidate>
                    <div class="field">
                        <label for="project-title">Nombre del proyecto</label>
                        <input id="project-title" name="project_title" type="text" required placeholder="Ej. Evaluación de impacto tecnológico">
                    </div>

                    <!-- Crear un espacio para agregar autores (1 a 5), y que sólo uno sea el de correspondencia  -->
                     <!-- quiero que se pongan por separado, que se busquen en la base de datos, y que haya un botón para agregar otro -->
                    
                    <div class="authors-container">
                        <div class="field">
                            <label for="add-authors">Autores extra del proyecto (tu ya estas incluido)</label><br>
                        </div>
                        <!-- <div class="author-item">
                            <div class="author-autocomplete">
                                <div class="field">
                                    <label for="author-name-1">Nombre del autor</label>
                                    <input id="author-name-1" name="author-name" type="text" required placeholder="Ej. Juan Pérez" autocomplete="off" data-author-input>
                                    <div class="author-autocomplete-dropdown" data-autocomplete-dropdown></div>
                                </div>
                            </div>
                        </div> -->

                        <button type="button" id="add-author-button" class="btn-secondary" onclick="agregarAutor()">+</button>
                    </div>

                    <div class="authors-container">
                        <div class="author-item">
                            <div class="author-autocomplete">
                                <div class="field">
                                    <label for="author-correspondencia">Autor de correspondencia</label>
                                    <input id="author-correspondencia" name="author-name" type="text" required placeholder="Ej. Juan Pérez" autocomplete="off" data-author-input>
                                    <div class="author-autocomplete-dropdown" data-autocomplete-dropdown></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label for="knowledge-area">Área de conocimiento</label>

            
                        <select id="area-conocimiento" name="knowledge_area" required>
                            <option value="0" selected>Seleccione una opción</option>
                            <option value="1">Ingeniería Química y Bioquímica</option>
                            <option value="2">Ingeniería Industrial</option>
                            <option value="3">Sistemas Computacionales y TI</option>
                            <option value="4">Ingeniería en Gestión Empresarial</option>
                            <option value="5">Ingeniería Eléctrica y Electrónica</option>
                            <option value="6">Ingeniería Mecánica y Mecatrónica</option>
                            <option value="7">Ingeniería en Energías Renovables</option>
                            <option value="8">Ingeniería en Semiconductores</option>
                            <option value="9">Administración</option>
                            <option value="10">Investigación Educativa</option>
                        </select>
                    </div>

                    <div class="field">
                        <label for="project-file">Entrega inicial (DOCX)</label>
                        <div class="dropzone" data-dropzone>
                            <input id="project-file" name="initial_file" type="file" accept="application/vnd.openxmlformats-officedocument.wordprocessingml.document" hidden required>
                            <div class="dz-inner">
                                <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 5 17 10"></polyline>
                                    <line x1="12" y1="5" x2="12" y2="16"></line>
                                </svg>
                                <p><strong>Arrastra tu DOCX</strong> o</p>
                                <button type="button" class="btn-secondary" data-dropzone-trigger>Seleccionar archivo</button>
                                <div class="file-info" data-dropzone-info aria-live="polite"></div>
                            </div>
                        </div>
                    </div>

                    <div class="actions">
                        <button type="button" class="btn-primary" onclick="crearProyecto()">Crear proyecto</button>
                        <p class="muted small">El proyecto se crea con la versión inicial y queda listo para seguimiento y revisiones.</p>
                    </div>
                </form>
            </article>

            

            <!-- LISTADO DE PROYECTOS DEL AUTOR -->
            <div class="project-board" aria-live="polite">
                <div class="project-board-tools">
                    <!-- <label class="sr-only" for="project-search">Buscar proyectos:</label>
                    <div class="project-board-search">
                        <span class="project-board-search__icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="7"></circle>
                                <line x1="16.65" y1="16.65" x2="21" y2="21"></line>
                            </svg>
                        </span>
                        <input id="project-search" type="search" placeholder="Buscar por título, autor o fecha...">
                    </div> -->
                </div>

                <div class="project-list" data-page-size="5">

                    <article class="card project-card is-review" data-title="Estudio de biomateriales" data-author="Equipo biomateriales" data-date="2025-11-01" aria-labelledby="project-01-title">
                        <header class="project-card__header">
                            <div>
                                <h3 class="project-title">NOMBRE DEL PROYECTO</h3>
                                <p class="project-description">Proyecto cargado el 20/10/2025</p>
                            </div>
                            <span class="project-status">ACEPTADO</span>
                        </header>
                        <div class="version-grid">
                            <section class="version version-initial is-ready">
                                <header>
                                    <h4>Versión inicial</h4>
                                    <span class="chip chip-denied">
                                        No aceptado
                                    </span>
                                </header>
                                <p class="muted small">Subido el 20/10/2025</p>
                                <a class="link" href="${proj.entregas[0].pdfPath}" target="_blank">Descargar PDF</a>
                            </section>
        
                            <section class="version version-revised ${proj.entregas[1].entregado ? 'is-ready' : 'is-await'}">
                                <header>
                                    <h4>Aún no has subido la versión revisada</h4>
                                    <span class="chip chip-pending">
                                        Pendiente
                                    </span>
                                </header>
                                <button type="button" class="btn-outline">Subir corrección</button>
                            </section>
                        </div>
                    </article>


                </div>

                <div id="project-empty" class="project-empty" hidden>
                    <p>No encontramos proyectos que coincidan con tu búsqueda.</p>
                </div>

                <div class="project-pagination" id="project-pagination">
                    <button type="button" class="btn-secondary project-page-btn" id="project-prev" aria-label="Proyectos anteriores">Anterior</button>
                    <span class="project-page-indicator" id="project-page-indicator">1 / 1</span>
                    <button type="button" class="btn-secondary project-page-btn" id="project-next" aria-label="Proyectos siguientes">Siguiente</button>
                </div>
            </div>
        </section>
    </main>




    <!-- SCRIPT PARA QUE NO TE DEJE ENTRAR SI NO ESTAS LOGGED IN -->
    <!-- <script>
        if (!sessionStorage.getItem('userId')) {
            window.location.href = 'login.html';
        }
    </script> -->

    <!-- SCRIPT PARA AGREGAR UN NUEVO AUTOR -->
    <script>
        // Función para buscar autores en la BD (preparada para cuando se cree el endpoint)
        async function buscarAutores(query) {
            if (!query || query.length < 1) {
                return [];
            }

            try {
                const res = await fetch(`../php/buscarAutores.php`, {
                    credentials: "same-origin"
                });
                const data = await res.json();                

                console.log(data);

                // Filtrar por nombre o correo
                const queryLower = query.toLowerCase();
                return data.autores.filter(autor => 
                    autor.nombre.toLowerCase().includes(queryLower) ||
                    autor.correo.toLowerCase().includes(queryLower) ||
                    autor.primerApellido.toLowerCase().includes(queryLower) ||
                    autor.segundoApellido.toLowerCase().includes(queryLower)

                );
            } catch (error) {
                console.error('Error al buscar autores:', error);
                return [];
            }
        }

        // Función para inicializar el autocomplete en un input
        function inicializarAutocomplete(input) {
            const dropdown = input.parentElement.querySelector('[data-autocomplete-dropdown]');
            if (!dropdown) return;

            let selectedIndex = -1;
            let autores = [];
            let timeoutId = null;

            // Función para mostrar el dropdown
            function mostrarDropdown() {
                dropdown.classList.add('is-visible');
            }

            // Función para ocultar el dropdown
            function ocultarDropdown() {
                dropdown.classList.remove('is-visible');
                selectedIndex = -1;
            }

            // Función para renderizar los resultados
            function renderizarResultados(resultados) {
                dropdown.innerHTML = '';
                autores = resultados;

                if (resultados.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'author-autocomplete-empty';
                    empty.textContent = 'No se encontraron autores';
                    dropdown.appendChild(empty);
                    return;
                }

                resultados.forEach((autor, index) => {
                    const item = document.createElement('div');
                    item.className = 'author-autocomplete-item';
                    item.textContent = `${autor.nombre} ${autor.primerApellido} ${autor.segundoApellido}`;
                    item.dataset.index = index;
                    
                    item.addEventListener('click', () => {
                        input.value = `${autor.nombre} ${autor.primerApellido} ${autor.segundoApellido}`;
                        input.dataset.authorId = autor.id;//TODO usar esto mejor para conseguir las ids
                        console.log(input.dataset);
                        ocultarDropdown();
                    });

                    item.addEventListener('mouseenter', () => {
                        selectedIndex = index;
                        actualizarHighlight();
                    });

                    dropdown.appendChild(item);
                });
            }

            // Función para actualizar el highlight
            function actualizarHighlight() {
                const items = dropdown.querySelectorAll('.author-autocomplete-item');
                items.forEach((item, index) => {
                    item.classList.toggle('is-highlighted', index === selectedIndex);
                });
            }

            // Event listener para el input
            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Limpiar timeout anterior
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }

                // Si el input está vacío, ocultar dropdown
                if (query.length < 2) {
                    ocultarDropdown();
                    return;
                }

                // Debounce: esperar 300ms después de que el usuario deje de escribir
                timeoutId = setTimeout(async () => {
                    const resultados = await buscarAutores(query);
                    renderizarResultados(resultados);
                    mostrarDropdown();
                }, 300);
            });

            // Event listener para cuando el input recibe foco
            input.addEventListener('focus', async () => {
                const query = input.value.trim();
                if (query.length >= 2) {
                    const resultados = await buscarAutores(query);
                    renderizarResultados(resultados);
                    mostrarDropdown();
                }
            });

            // Event listener para navegación con teclado
            input.addEventListener('keydown', (e) => {
                const items = dropdown.querySelectorAll('.author-autocomplete-item');
                
                if (!dropdown.classList.contains('is-visible') || items.length === 0) {
                    return;
                }

                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                        actualizarHighlight();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, -1);
                        actualizarHighlight();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selectedIndex >= 0 && autores[selectedIndex]) {
                            input.value = autores[selectedIndex].nombre;
                            input.dataset.authorId = autores[selectedIndex].id;
                            ocultarDropdown();
                        }
                        break;
                    case 'Escape':
                        ocultarDropdown();
                        break;
                }
            });

            // Ocultar dropdown al hacer click fuera
            document.addEventListener('click', (e) => {
                if (!input.parentElement.contains(e.target)) {
                    ocultarDropdown();
                }
            });
        }

        function agregarAutor() {
            const authorsContainer = document.querySelector('.authors-container');
            const addButton = authorsContainer.querySelector('#add-author-button');

            // Contar solo los author-item, excluyendo el botón de agregar
            const authorItems = authorsContainer.querySelectorAll('.author-item');
            
            if(authorItems.length >= 4) {
                alert("No se pueden agregar más de 5 autores.");
                return;
            }

            const authorItem = document.createElement('div');
            authorItem.className = 'author-item';

            const fieldWrapper = document.createElement('div');
            fieldWrapper.style.display = 'flex';
            fieldWrapper.style.gap = '10px';
            fieldWrapper.style.alignItems = 'flex-end';

            const autocompleteWrapper = document.createElement('div');
            autocompleteWrapper.className = 'author-autocomplete';

            const field = document.createElement('div');
            field.className = 'field';
            field.style.flex = '1';

            const authorIndex = authorItems.length + 1;
            const inputId = `author-name-${authorIndex}`;

            const label = document.createElement('label');
            label.setAttribute('for', inputId);
            label.textContent = 'Nombre del autor';

            const input = document.createElement('input');
            input.id = inputId;
            input.type = 'text';
            input.name = `author-name-${authorIndex}`;
            input.required = true;
            input.placeholder = 'Ej. Juan Pérez';
            input.autocomplete = 'off';
            input.setAttribute('data-author-input', '');
            
            const dropdown = document.createElement('div');
            dropdown.className = 'author-autocomplete-dropdown';
            dropdown.setAttribute('data-autocomplete-dropdown', '');

            field.appendChild(label);
            field.appendChild(input);
            field.appendChild(dropdown);

            autocompleteWrapper.appendChild(field);

            const deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'btn-secondary';
            deleteButton.textContent = '−';
            deleteButton.setAttribute('aria-label', 'Eliminar autor');
            deleteButton.onclick = function() {
                eliminarAutor(authorItem);
            };

            fieldWrapper.appendChild(autocompleteWrapper);
            fieldWrapper.appendChild(deleteButton);

            authorItem.appendChild(fieldWrapper);

            // Insertar antes del botón de agregar autor
            authorsContainer.insertBefore(authorItem, addButton);

            // Inicializar autocomplete en el nuevo input
            inicializarAutocomplete(input);
        }

        function eliminarAutor(authorItem) {
            if (!authorItem) {
                return;
            }
            
            const authorsContainer = document.querySelector('.authors-container');
            const authorItems = authorsContainer.querySelectorAll('.author-item');
            
            authorItem.remove();
        }

        // Inicializar autocomplete en el input inicial cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            const initialInput = document.getElementById('author-correspondencia');
            if (initialInput) {
                inicializarAutocomplete(initialInput);
            }
        });
    </script>

    <!-- SCRIPT PARA CARGAR LOS PROYECTOS AL CARGAR LA PÁGINA -->
    <script>
    //esta funcion se ejecuta al cargar la pagina
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects(); // llama a la función que obtiene los proyectos y los renderiza
        });
    </script>
    <script>
        //helper par poder construir elementos como lego
        function el(tag, options = {}) {
        const node = document.createElement(tag);

        if (options.class) node.className = options.class;
        if (options.text) node.textContent = options.text;
        if (options.html) node.innerHTML = options.html; 
        if (options.attrs) {
            for (const [k, v] of Object.entries(options.attrs)) {
                node.setAttribute(k, v);
            }
        }
        if (options.children) {
            options.children.forEach(child => node.appendChild(child));
        }

        return node;
    }
    </script>
    <script>
        //helper para construir las card de las entregas
        function makeEntrega(entrega, titulo, isInitial) {
            const section = el("section", {
                class: `version ${isInitial ? "version-initial" : "version-revised"} ${entrega.entregado ? "is-ready" : "is-await"}`
            });

            const header = el("header", {
                children: [
                    el("h4", { text: titulo }),
                    el("span", {
                        class: `chip ${entrega.entregado ? "chip-success" : "chip-pending"}`,
                        text: entrega.entregado ? (entrega.aceptado ? "Aceptada" : "Recibida") : "Pendiente"
                    })
                ]
            });

            const fecha = el("p", {
                class: "muted small",
                text: entrega.entregado
                    ? `Subido el ${entrega.fechaEntrega}`
                    : "Pendiente de subir."
            });

            section.append(header, fecha);

            if (entrega.pdfPath) {
                section.appendChild(
                    el("a", {
                        class: "link",
                        text: "Descargar PDF",
                        attrs: { href: entrega.pdfPath, target: "_blank" }
                    })
                );
            }

            //meto para ver la rubrica 
            if (entrega.aceptado != null) {
                console.log("entro a ver rubrica");
                section.appendChild(
                    el("a", {
                        class: "link",
                        text: "Ver rubrica",
                        attrs: { href: `./author-verRubrica.html?title=${titulo}&id=${entrega.id}` }
                    })
                );
            }

            return section;
        }
    </script>

    <!-- SCRIPT PARA RENDERIZAR LOS PROYECTOS EN EL HTML -->
    <script>
    //esta funcion renderiza los proyectos en el HTML
    function renderProjects(projects) {
        const board = document.querySelector('.project-list');
        board.innerHTML = ''; // quita los proyectos placeholder

        console.log(projects);
        projects.forEach(proj => {
            const card = el("article", {
                class: "card project-card",
                attrs: {
                    "data-title": proj.nombre,
                }
            });

            const e = proj.entregas[0];

            const header = el("header", { class: "project-card__header" });

            const headerInfo = el("div", {
                children: [
                    el("h3", { class: "project-title", text: proj.nombre }),
                    el("p", { class: "project-description", text: `Proyecto cargado el ${e.fechaEntrega}` })
                ]
            });

            const status = el("span", {
                class: `project-status ${e.aceptado ? 'chip-success' : ""}`,
                text: e.aceptado ? "Aceptado" : "En revisión"
            });

            header.append(headerInfo, status);

            const grid = el("div", { class: "version-grid" });
            grid.appendChild(makeEntrega(e, proj.nombre, true));

            // Usa la segunda entrega como fecha si existe
            if (proj.entregas.length > 1) {
                //le pongo la date
                card.dataset.date = proj.entregas[1].fechaEntrega;

                const status = el("span", {
                    class: `project-status ${proj.entregas[0].aceptado ? 'chip-success' : ""}`,
                    text: proj.entregas[0].aceptado ? "Aceptado" : "En revisión"
                });

                header.append(headerInfo, status);

                // creo la carta de la otra entrega
                grid.appendChild(makeEntrega(proj.entregas[1], proj.nombre, false));

            }

            card.append(header, grid);
            document.querySelector('.project-list').appendChild(card); // o donde vayan tus cards
    });

    }

    //esta funcion obtiene los proyectos del autor
    async function loadProjects() {
        try {
            const res = await fetch("../php/autor_getProyectos.php", { credentials: "same-origin" });
            const data = await res.json();
            if (!data.success) {
                console.error(data.message);
                return;
            }
            console.log(data);
            renderProjects(data.proyectos);
        } catch (error) {
            console.error("Error al cargar proyectos:", error);
        }
    }
    </script>

    <!-- SCRIPT PARA CREAR UN NUEVO PROYECTO -->
    <script>
        async function crearProyecto(){
            //consigo los datos
            const titulo = document.getElementById('project-title').value;
            const autorCorrespondencia = document.querySelector('#author-correspondencia');
            const archivo = document.getElementById('project-file').files[0];
            const areaDeConocimiento = document.querySelector('#area-conocimiento').value;
            
            //loopeo por los autores si es que hay autores extra
            const authorsContainer = document.querySelectorAll('.authors-container')[0];
            const inputs = authorsContainer.querySelectorAll('input[data-author-input]');
            const idAutores = [];

            inputs.forEach(input => {
                idAutores.push(input.dataset.authorId);
            });

            //consigo todos los autores de la bdd
            const respuestaAutores = await fetch("../php/buscarAutores.php", { credentials: "same-origin" });
            const autoresBdd = await respuestaAutores.json();
            if (!autoresBdd.success) {
                console.error(autoresBdd.message);
                return;
            }

            let autoresValidos = true;

            if (!autoresValidos) {
                alert("Alguno de los autores ingresados no existen en la base de datos.");
                return;
            }

            /*VALIDACIONES DE*/
            //titulo
            if (!titulo) {
                alert("Por favor ingresa el nombre del proyecto.");
                return;
            }

            //autor de correspondencia
            if (!autorCorrespondencia.value) {
                alert("Por favor selecciona un autor de correspondencia.");
                return;
            }
            let autorCorrespondenciaId = autorCorrespondencia.dataset.authorId;

            if (!autorCorrespondenciaId) {
                alert("Por favor selecciona un autor de correspondencia.");
                return;
            }

            //consigo mi id de los params
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            console.log("VALORS")
            console.log(idAutores);
            console.log(id);
            console.log(autorCorrespondenciaId);
            console.log(idAutores.includes(autorCorrespondenciaId));
            if (!(idAutores.includes(autorCorrespondenciaId) || id == autorCorrespondenciaId)) {
                alert ("El autor de correspondencia debe ser un autor del proyecto.");
            }

            //archivo
            if (!archivo) {
                alert("Por favor selecciona un archivo DOCX para la entrega inicial.");
                return;
            }

            //area de conocimiento
            if (areaDeConocimiento === '0') {
                alert("Por favor ingrese el area de conocimiento.");
                return;
            }


            //para mandar archivos no puede ser con json, tiene que ser con FormData
            const formData = new FormData();
            formData.append('titulo', titulo);
            formData.append('archivo', archivo);
            formData.append('autores', JSON.stringify(idAutores));
            formData.append('autorCorrespondenciaId', autorCorrespondenciaId);

            const res = await fetch("../php/autor_crearProyecto.php", {
                method: "POST",
                body: formData,
                credentials: "same-origin" // para enviar cookies de la sesion
            });

            const data = await res.json();

            if (!data.success) {
                alert(data.message);
                return;
            }else{
                loadProjects(); // recarga los proyectos para mostrar el nuevo
                alert("Proyecto creado con éxito.");
            }
        }
    </script>


    <!-- SCRIPT PARA EL BOARD DE PROYECTOS (PAGINACIÓN Y BÚSQUEDA)-->
    <script>
    (function () {
        const dropzones = document.querySelectorAll('[data-dropzone]');

        dropzones.forEach(function (zone) {
            const input = zone.querySelector('input[type="file"]');
            const trigger = zone.querySelector('[data-dropzone-trigger]');
            const info = zone.querySelector('[data-dropzone-info]');

            if (!input) { return; }

            function setInfo(file) {
                if (!info) { return; }
                if (!file) { info.textContent = ''; return; }
                var sizeInKb = file.size / 1024;
                var formatted = sizeInKb < 1024 ? sizeInKb.toFixed(1) + ' KB' : (sizeInKb / 1024).toFixed(2) + ' MB';
                info.textContent = file.name + ' · ' + formatted;
            }

            ['dragenter', 'dragover'].forEach(function (eventName) {
                zone.addEventListener(eventName, function (event) {
                    event.preventDefault();
                    event.stopPropagation();
                    zone.classList.add('is-dragover');
                });
            });

            ['dragleave', 'drop'].forEach(function (eventName) {
                zone.addEventListener(eventName, function (event) {
                    event.preventDefault();
                    event.stopPropagation();
                    zone.classList.remove('is-dragover');
                });
            });

            zone.addEventListener('drop', function (event) {
                if (event.dataTransfer && event.dataTransfer.files && event.dataTransfer.files[0]) {
                    var file = event.dataTransfer.files[0];
                    input.files = event.dataTransfer.files;
                    setInfo(file);
                }
            });

            if (trigger) {
                trigger.addEventListener('click', function () {
                    input.click();
                });
            }

            input.addEventListener('change', function () {
                setInfo(input.files && input.files[0]);
            });
        });
        const board = document.querySelector('.project-list');
        if (!board) { return; }

        const pageSize = Number(board.dataset.pageSize) || 5;
        const allCards = Array.from(board.querySelectorAll('.project-card'));
        const searchInput = document.getElementById('project-search');
        const emptyState = document.getElementById('project-empty');
        const pagination = document.getElementById('project-pagination');
        const prevBtn = document.getElementById('project-prev');
        const nextBtn = document.getElementById('project-next');
        const pageIndicator = document.getElementById('project-page-indicator');

        let filteredCards = allCards.slice();
        let currentPage = 1;

        function updateVisibility() {
            const total = filteredCards.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            currentPage = Math.min(currentPage, totalPages);

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const visibleSet = new Set(filteredCards.slice(start, end));


            allCards.forEach(card => {
                card.hidden = !visibleSet.has(card);
            });

            emptyState.hidden = (total > 0 || !searchInput.value.trim());
            pagination.hidden = total <= pageSize;
            pageIndicator.textContent = total ? currentPage + ' / ' + totalPages : '0 / 0';
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }

        function applySearch(value) {
            const term = value.trim().toLowerCase();
            if (!term) {
                filteredCards = allCards.slice();
            } else {
                filteredCards = allCards.filter(card => {
                    const title = (card.dataset.title || card.querySelector('.project-title')?.textContent || '').toLowerCase();
                    const author = (card.dataset.author || '').toLowerCase();
                    const date = (card.dataset.date || '').toLowerCase();
                    return title.includes(term) || author.includes(term) || date.includes(term);
                });
            }
            currentPage = 1;
            updateVisibility();
        }

        if (searchInput) {
            searchInput.addEventListener('input', event => {
                applySearch(event.target.value);
            });
        }

        prevBtn.addEventListener('click', () => {
            if (currentPage <= 1) { return; }
            currentPage -= 1;
            updateVisibility();
            board.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        nextBtn.addEventListener('click', () => {
            const totalPages = Math.max(1, Math.ceil(filteredCards.length / pageSize));
            if (currentPage >= totalPages) { return; }
            currentPage += 1;
            updateVisibility();
            board.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        updateVisibility();
    })();
    </script>
</body>
</html>

